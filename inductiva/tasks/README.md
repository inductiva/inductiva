# Tasks

## Submitting tasks

### Sync. vs Async.

The **Inductiva API** client allows running simulations both synchronously and asynchronously.
This can be achieved by specifying the `run_async` argument to `scenario.simulate()` and `simulator.run()` calls.
When a task is submitted synchronously, the client blocks until its outputs are ready.
Note that if the local process is interrupted (with `CTRL+C` or a client-side exception), the task running remotely will be killed.
On the other hand, when a task is submitted asynchronously, the client unblocks after  submitting the simulation. The the user immediately gets a `Task` object, which is described in further detail [below](#managing-tasks). If the user calls `task.wait()`, the task will block until it completes, but without interrupting the remote task if the local process is interrupted.

To recap:

```python

my_scenario = inductiva.molecules.ProteinSolvation(
    protein_pdb="my_protein.pdb"
)

# Run simulation blocking the client, and killing the remote task if the local
# process is interrupted.
task = my_scenario.simulate()

# Run simulation without blocking the client.
task = my_scenario.simulate(run_async=True)

# Run simulation async, blocking the client after submitting the task.
task = my_senario.simulate(run_async=True)
# This will block the client until the task completes.
task.wait()

# Run simulation async, turning it into a blocking call with the behavior of
# killing the remote process if the local process is killed.
task = my_scenario.simulate(run_async=True)
with task.sync_context():
    task.wait()
```






## Managing tasks




The `Task` class provides methods for managing a specific task submitted to the **Inductiva API**. You get an instance of `Task` everytime you create a simulation. Moreover, you can [retrieve previously created tasks](#retrieving-tasks-from-previous-sessions).
With a `Task` object, you can:
 * Get its status;
 * Get the machine type where it ran/is running;
 * Kill it if you've changed your mind;
 * Download output files (all of them or only the important ones);
 * Get its execution time.

### Examples:

```python
# `scenario` constructed as in the examples above.
# ... stands for arguments related to each specific scenario.
task = scenario.simulate(..., run_async=True)

# Get status of the task.
status = task.get_status()
print(status) # would be, e.g., "submitted", "started", "success", "failed", "killed"

# Kill a task that hasn't completed yet.
if status == "submitted" or status == "started":
    task.kill()
```

```python

task = scenario.simulate(..., run_async=True)

# Get the output of the task. If the task is still running, this will block
# until the outputs are ready.
# `output` objects vary depending on the scenario, exposing methods to
# manipulate the results that are relevant for that scenario!
output = task.get_output()

# Alternatively, download the raw output files!

# If you don't know the files generated by your task, you can get an object
# representing information on the output files.
outputs_info = task.get_output_files_info()

full_download_size = outputs_info.size # Size of the full output archive.
files = outputs_info.contents # List of individual files available.

# Pretty print information on the output archive.
print(outputs_info)
# Archive size: 1.64 GiB
# Contents:
#  Size         Compressed   Name
#  191 B        96 B         stderr.txt
#  138.24 KiB   16.73 KiB    stdout.txt
# ...
#  3.80 MiB     3.61 MiB     important_file1.txt
#  1.27 MiB     1.21 MiB     important_file2.txt


# Download only those you are interested in:
output_dir = task.download_outputs(
    filenames=["important_file1.txt", "important_file2.txt"])
# 100%|██████████| 4.82M/4.82M [00:00<00:00, 273MiB/s]

# Or all the generated files for archival, without extracting the
# downloaded zip.
output_dir = task.download_outputs(uncompress=False)
# 100%|██████████| 1.64G/1.64G [00:32<00:00, 55.1MiB/s]
```

## Retrieving tasks from previous sessions

A fundamental aspect of the API is its ability to run long tasks asynchronously.
You can retrieve previously created tasks and reconstruct the `Task` objects - the same objects that you get from the call to `scenario.simulate()` - using the `inductiva.tasks.get()` function.
It requires an argument named `last_n`, which specifies the number of most recent tasks submitted to the API to retrieve. It returns a list of `Task` objects so that you can resume manipulating the task and its results.
Additionally, you can filter tasks by their current status, which allows you to get, for instance, only tasks that failed or only
tasks that are submitted and not yet started.

### Examples:

```python
import inductiva

# Get my last 10 submitted tasks.
tasks = inductiva.tasks.get(last_n=10)

# Get my last 10 tasks that ran successfuly.
tasks = inductiva.tasks.get(last_n=10, status="success")

# You can use the task objects to manipulate the tasks.
not_started_tasks = inductiva.tasks.get(last_n=5, status="submitted")
for task in not_started_tasks:
    task.kill()

successful_tasks = inductiva.tasks.get(last_n=20, status="success")
for task in successful_tasks:
    task.download_outputs()
```

Another function named `list`, which shares the same arguments as `get`, can be used to print information about the
tasks in tabular format to the console:

```python
import inductiva

# list the last 5 tasks that were successful
inductiva.tasks.list(5, status="success")
#                     ID       Simulator               Status            Submitted              Started        Duration            VM Type
#  1691150776862178362        openfoam              success     04 Aug, 12:06:17     04 Aug, 12:06:18       0h 1m 53s      c2-standard-8
#  1691149904961476240        openfoam              success     04 Aug, 11:51:46     04 Aug, 11:51:46       0h 1m 28s      c2-standard-8
#  1691081881158823776        openfoam              success     03 Aug, 16:58:02     03 Aug, 16:58:02       0h 1m 20s     n2-standard-32
#  1691081409916619414        openfoam              success     03 Aug, 16:50:11     03 Aug, 16:50:11       0h 1m 20s     n2-standard-32
#  1691080520213617518        openfoam              success     03 Aug, 16:35:21     03 Aug, 16:35:21       0h 1m 23s     n2-standard-32
```
