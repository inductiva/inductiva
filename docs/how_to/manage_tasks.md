# Managing a task

An important step in the user's workflow is monitoring/managing tasks. Whether
the user is simply trying to follow the progress of a simulation, retrieve results,
or even kill a task, the `Task` class provides the necessary tools to do so.
In this section, we will cover the following topics:

 * [Task monitoring](#task-monitoring): Learn how to monitor a task, such as
   getting its status and getting information about the outputs;
 * [Killing tasks](#killing-tasks): Learn how to kill a task that hasn't
   been completed yet;
 * [Downloading Outputs](#downloading-outputs): Learn how to download the
   outputs of a task.

#### Task monitoring

The `Task` class provides mechanisms to track and manage the status of a task.
With a `Task` object at hand, the user can:
 * Get the status, i.e., whether the task is started, succeeded, failed, etc
 (see the section about [task lifecycle](../introduction/tasks#task-lifecycle)
 for more details);
 * Get the machine type where it ran/is running;
 * Get the execution time.

The following snippets show how to use the `Task` class to manage a task.

```python
# create a new task or retrieve a task from a previous session
# task = simulator.run(...)
#   or 
# task = Task("i4ir3kvv62odsfrhko4y8w2an")

# Get status of the task.
>>> task.get_status()
<DynamicSchema: 'success'>

# Get the computational resource type where the task is
# running or was submitted to
>>> task.get_machine_type()
'c2-standard-4'

>>> task.get_computation_time()
'00:03:12'

# Get information about the output files generated by the simulation
>>> output_files_info = task.get_output_files_info()
>>> print(output_files_info)
Archive size: 262.00 KB
Contents:
  Size         Compressed   Name
  3.12 KB      859 B        stdout.txt
  242 B        160 B        stderr.txt
  5.76 KB      4.10 KB      vtk/ParticleData_Fluid_40.vtk
  5.76 KB      4.09 KB      vtk/ParticleData_Fluid_32.vtk
  5.76 KB      4.09 KB      vtk/ParticleData_Fluid_17.vtk
  ...
  4.98 KB      989 B        log/SPH_log.txt

```

Other than just retrieving information about the task, the user has the option
to control 


#### Killing tasks

Sometimes, a user finds out that there is a reason to not allow a task to reach
a final state. Whether there is a mistake in the simulation input files, a
running simulation has gone rogue, or simply because there is no other reason
to allow a task to proceed, the user can kill a task. The `Task` class provides
a method to kill a task that hasn't been completed yet. Tasks in the
`PENDING INPUT`, `SUBMITTED` and `STARTED` states can be killed (see the section
on [task lifecycle](../introduction/tasks#task-lifecycle)).

To kill a task programmatically, one has 2 options at hand: by declaratively
calling the `kill` method or interrupting the python session/script
when a task is being waited in the context of a `sync_context` call:

```python
# grab a task object and
# declaratively emit a kill command
>>> task = Task("i4ir3kvv62odsfrhko4y8w2an")
>>> task.kill()

# or interrupt the session while waiting for the task to complete
>>> with tak.sync_context():
        task.wait()  # <-- The remote simulation WILL DIE if the local session is
                     #     interrupted while waiting for the wait() call to return
                     #     (Ex. the user presses Ctrl+C)

```

Alternatively, the user can resort to the command line interface to kill the task:

```bash
$ inductiva tasks kill i4ir3kvv62odsfrhko4y8w2an
You are about to kill the following tasks:
  - i4ir3kvv62odsfrhko4y8w2an
Are you sure you want to proceed (y/[N])? y
Successfully sent kill request for task i4ir3kvv62odsfrhko4y8w2an.
```

#### Downloading outputs

Downloading the outputs of a task is a common operation. In the following
snippets, we show how to download the outputs of a finished task and how to
control which files and where the files are downloaded to.

```python
# Download all the files produced by the task
>>> output_dir = task.download_outputs()
Downloading simulation outputs to inductiva_output/i4ir3kvv62odsfrhko4y8w2an/output.zip.
100%|██████████████████████████████████████| 5.04M/5.04M [00:00<00:00, 13.3MB/s]
Uncompressing the outputs to inductiva_output/i4ir3kvv62odsfrhko4y8w2an/
>>> print(ouptut_dir)
PosixPath('inductiva_output/i4ir3kvv62odsfrhko4y8w2an')
```

The downloaded files can be inspected using the `ls` command:

```bash
$ ls -1 inductiva_output/i4ir3kvv62odsfrhko4y8w2an
log
stderr.txt
stdout.txt
vtk
```

By default, all output files are downloaded to a directory named after the task
into a parent directory named `inductiva_output`. For example, the outputs
of the task with id `abc123` would be downloaded to `inductiva_output/abc123/`.
The name of the parent directory is a package-level variable that applies to all
downloads with a session. It prevents the user from cluttering the current
working directory with a large number of downloaded files. However, the user can
change this behavior by setting the parent directory name using the
`inductiva.set_output_dir` function.

```python
>>> import inductiva
# set the parent directory name
>>> inductiva.get_output_dir()
'inductiva_output'
>>> inductiva.set_output_dir("my_vault")
>>> inductiva.get_output_dir()
'my_vault'

# download the outputs again
>>> output_dir = task.download_outputs()
Downloading simulation outputs to my_vault/i4ir3kvv62odsfrhko4y8w2an/output.zip.
100%|██████████████████████████████████████| 5.04M/5.04M [00:00<00:00, 13.3MB/s]
Uncompressing the outputs to my_vault/i4ir3kvv62odsfrhko4y8w2an/
>>> print(ouptut_dir)
PosixPath('my_vault/i4ir3kvv62odsfrhko4y8w2an')

# Unset the parent directory name so that all downloads are done to the current
# working directory
>>> inductiva.set_output_dir(None)
>>> output_dir = task.download_outputs()
Downloading simulation outputs to i4ir3kvv62odsfrhko4y8w2an/output.zip.
100%|██████████████████████████████████████| 5.04M/5.04M [00:00<00:00, 13.3MB/s]
Uncompressing the outputs to i4ir3kvv62odsfrhko4y8w2an/
>>> print(ouptut_dir)
PosixPath('i4ir3kvv62odsfrhko4y8w2an')
```

The `download_outputs` method of the `Task` class has the option to specify the
name of the folder where the outputs are downloaded inside the parent directory.

```python
# reset the parent directory name to the default
>>> inductiva.set_output_dir("inductiva_outputs")
>>> output_dir = task.download_outputs(output_dir="my_outputs")
Downloading simulation outputs to inductiva_output/my_outputs/output.zip.
100%|██████████████████████████████████████| 5.04M/5.04M [00:00<00:00, 13.3MB/s]
Uncompressing the outputs to inductiva_output/my_outputs/
>>> print(ouptut_dir)
PosixPath('inductiva_output/my_outputs')
```

In addition to controlling how downloaded files are organized, the user can also
configure which files to download. By default, all files produced by the task are
downloaded. However, the user can select to retrieve only a subset of those files
by specifying the filenames of interest:

```python
# Download only the files of interest
>>> output_dir = task.download_outputs(filenames=["stdout.txt", "stderr.txt"]
                                       output_dir="my_outputs")
Downloading simulation outputs to inductiva_output/my_outputs/output.zip.
100%|██████████████████████████████████████| 1.04k/1.04k [00:00<00:00, 671kB/s]
Uncompressing the outputs to inductiva_output/my_outputs/
```
In this case, we can confirm that only the files `stdout.txt` and `stderr.txt`
were indeed downloaded:

```bash
$ ls -1 inductiva_output/my_outputs
stderr.txt
stdout.txt
```
